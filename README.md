# CHISEL-CHIP QUICKLY START

***A RISC-V PROCESSOR CREATED BY CHISEL***

---

## QUICKLY START

- Clone the repository

  ```bash
  git clone https://github.com/xidianswq/Chisel-Chip.git
  ```

- Set up environment

  ```bash
  # Install Java
  sudo apt install default-jre
  # Import GPG Key
  echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" | sudo tee /etc/apt/sources.list.d/sbt.list
  echo "deb https://repo.scala-sbt.org/scalasbt/debian /" | sudo tee /etc/apt/sources.list.d/sbt_old.list
  curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823" | sudo apt-key add
  # Updata apt-get Source
  sudo apt-get update
  # Get sbt
  sudo apt-get install sbt
  # Check Installation Success 
  sbt sbtVersion
  ```

- Compile the project

  ```bash
  ## Basic Commands
  # Compile the Project 
  sbt run
  # Run Scala Test File
  # $sbt "testOnly <package_name>.<class_name> [-- -DwriteVcd=1]"
  sbt "testOnly cpu.CPUTest -- -DwriteVcd=1"
  # Check Waveform
  GTKWAVE test_run_dir/mycpu_should_work_well_through_hex/Top.vcd
  GTKWAVE test_run_dir/mycpu_should_work_well_through_hex/ChiselTest_wav.gtkw
  ```
  
  

---
## PROJECT STRUCTURE

```
tree                           explanation
├─doc                           - document
│  ├─pic                        - picture
│  │  ├─CPU                     - package cpu pic
│  │  ├─CPU_PIPELINE
│  │  └─SoC
│  ├─RISC-V_Pipeline_CPU_Design - ~.md pic
│  └─visio                      - cpu structure
├─generated                     - generated .v file
├─RISCV_CPU                     - Vivado project
├─src                           - source code
│  ├─main
│  │  ├─resources               - c & memory file
│  │  │  ├─AM                   - interface for SoC
│  │  │  │  └─device
│  │  │  ├─CPU                  - easy test file
│  │  │  └─ctest
│  │  │      ├─loop             - c & link file
│  │  │      │  ├─dump          - .dump file (ASM)
│  │  │      │  └─hex           - generated .hex file 
│  │  │      ├─soc
│  │  │      └─umimp
│  │  └─scala                   - chisel for packages
│  │      ├─core
│  │      ├─cpu
│  │      ├─cpu_pipeline
│  │      ├─pipeline_advance
│  │      ├─public
│  │      ├─riscv-tests
│  │      │  ├─cpu
│  │      │  ├─cpu_pipeline
│  │      │  └─pipeline_advance
│  │      └─soc
│  │          └─peripheral
│  ├─riscv-tests
│  │  ├─hex                     - hex generated by bin
│  │  ├─isa                     - ISA bin & .dump file             
│  │  └─results                 - ISA test results
│  └─test
│      └─scala                  - ChiselTest for packages
│          ├─core
│          ├─cpu
│          ├─cpu_pipeline
│          ├─pipeline_advance
│          ├─riscv-tests
│          │  ├─cpu
│          │  ├─cpu_pipeline
│          │  └─pipeline_advance
│          └─soc
└─test_run_dir                  - .vcd & .gtkw  file   
```



---

## PROJECT TEST

#### Build riscv-gnu-toolchain

- Get riscv-gnu-toolchain

  ```bash
  git clone https://github.com/riscv/riscv-gnu-toolchain
  sudo apt-get install autoconf automake autotools-dev curl python3 python3-pip python3-tomli libmpc-dev libmpfr-dev libgmp-dev gawk build-essential bison flex texinfo gperf libtool patchutils bc zlib1g-dev libexpat-dev ninja-build git cmake libglib2.0-dev libslirp-dev
  git submodule update --init --recursive
  ```

  or

  ```bash
  # 从gitee国内镜像下载速度很快
  git clone https://gitee.com/mirrors/riscv-gnu-toolchain.git
  cd riscv-gnu-toolchain
  git clone https://gitee.com/mirrors/riscv-dejagnu
  git clone -b riscv-gcc-10.2.0 https://gitee.com/mirrors/riscv-gcc
  git clone -b riscv-glibc-2.29 https://gitee.com/mirrors/riscv-glibc
  git clone https://gitee.com/mirrors/riscv-newlib
  git clone -b riscv-binutils-2.35 https://gitee.com/mirrors/riscv-binutils-gdb  riscv-binutils
  git clone -b fsf-gdb-10.1-with-sim https://gitee.com/mirrors/riscv-binutils-gdb  riscv-gdb
  # 将下载的库改名（去掉riscv-）
  ...
  # 安装相应依赖库
  sudo apt-get install autoconf automake autotools-dev curl python3 libmpc-dev libmpfr-dev libgmp-dev gawk build-essential bison flex texinfo gperf libtool patchutils bc zlib1g-dev libexpat-dev ninja-build
  ```

- Build

  ```bash
  # Create riscv Folder & Set Permissions
  sudo mkdir /opt/riscv
  sudo chmod 777 /opt/riscv
  # Add Excute Path
  sudo echo 'export RISCV=/opt/riscv' >> ~/.bashrc
  sudo echo 'export PATH=$RISCV/bin:$PATH' >> ~/.bashrc
  source ~/.bashrc
  # Build x32 & x64 Cross-Compilation Tools
  cd riscv-gnu-toolchain
  ./configure --prefix=/opt/riscv --enable-multilib
  sudo make 
  # Check Installation Success 
  riscv64-unknown-elf-gcc -v
  ```

- Compile .c file to .hex file

  see `Makefile` in `src/main/resources/ctests/...`
  
  use`make clean` to clean build files; `make build`to generate .hex file 
  
  ```bash
  # gcc: riscv64-unknown-elf-gcc -march=<ISA_type> -mabi=<ABI_type> -c [-o output_file.o] <source_file.c>
  riscv64-unknown-elf-gcc -march=rv32i -mabi=ilp32 -c -o test.o test.c
  # link: riscv64-unknown-elf-ld -b elf32-littleriscv <obj_file.o> -T <link_file.ld> [-o output_file]
  riscv64-unknown-elf-ld -b elf32-littleriscv test.o -T link.ld -o test
  # Convert Executable File to Bin File
  riscv64-unknown-elf-objcopy -O binary test test.bin
  ## Convert to Hex File
  # -An  : Hidden Address Info
  # -tx1 : Type is x1(1 byte hexadecimal)
  # -w1  : Width is 1(1 byte per line)
  # -v   : Omit Prohibited(using * instead)
  od -An -tx1 -w1 -v test.bin >> ./hex/test.hex
  # Create dump file
  riscv64-unknown-elf-objdump -b elf32-littleriscv -D test > ./dump/test.elf.dmp
  ```

> Makefile:
>
> ```makefile
> HEX_DIR = ./hex
> DUMP_DIR = ./dump
> GCCFLAGS = -march=rv32i -mabi=ilp32 -c
> ASFLAGS = -march=rv32i -mabi=ilp32 -misa-spec=2.2 -c
> LDFLAGS = -b elf32-littleriscv
> OBJCOPYFLAGS = -O binary
> ODFLAGS = -An -tx1 -w1 -v
> OBJECT = test
> 
> # 获取所有源文件
> SRCS = test.c $(wildcard device/*.c) 
> START = start.S
> OBJS = $(SRCS:.c=.o)
> START_OBJ = $(START:.S=.o)            
> 
> # 清理生成的文件
> clean:
> 	rm -rf $(HEX_DIR) $(DUMP_DIR)
> 	rm -f $(OBJECT) $(OBJECT).bin $(OBJS) $(START_OBJ)
> 
> # 编译和链接
> build: $(START_OBJ) $(OBJS)
> 	mkdir -p $(HEX_DIR) $(DUMP_DIR)
> 	riscv64-unknown-elf-ld $(LDFLAGS) $(OBJS) $(START_OBJ) -T link.ld -o $(OBJECT)
> 	riscv64-unknown-elf-objcopy $(OBJCOPYFLAGS) $(OBJECT) $(OBJECT).bin
> 	od $(ODFLAGS) $(OBJECT).bin >> $(HEX_DIR)/$(OBJECT).hex
> 	riscv64-unknown-elf-objdump -b elf32-littleriscv -D $(OBJECT) > $(DUMP_DIR)/$(OBJECT).elf.dmp
> 
> %.o: %.c
> 	riscv64-unknown-elf-gcc $(GCCFLAGS) $< -o $@
> 	
> %.o: %.S
> 	riscv64-unknown-elf-as $(ASFLAGS) $< -o $@
> 
> ```



---

#### Build riscv-tests

- Get riscv-tests

  ```bash
  git clone https://github.com/riscv-software-src/riscv-tests.git
  cd riscv-tests
  git submodule update --init --recursive
  ```

- Build

  ```bash
  autoconf
  ./configure --prefix=/opt/riscv/target
  cd isa
  # choice isa to make
  make rv32ui
  make rv32mi
  ```

---

#### Script used for riscv-tests
- add `io.globalpointer` logic in `Top.scala`
- compile isa .dump file to bin file by riscv-gnu-toolchain
- run Script used for riscv-tests
```bash
cd Chisel-Chip
# generate hex file in src/riscv-tests/hex
bash tohex.sh
# Test Isa for {package}cpu_riscv_tests in src/main/scala & src/test/scala
bash riscv-tests.sh 
sudo bash riscv-tests.sh cpu_riscv_tests cpu
```

